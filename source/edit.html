<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç¼–è¾‘æ–‡ç«  - Sun Blog</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
    header { padding: 10px; background: #222; color: white; display: flex; align-items: center; gap: 10px; }
    textarea { flex: 1; width: 50%; padding: 10px; font-size: 16px; }
    #preview { flex: 1; padding: 10px; overflow-y: auto; background: #f8f8f8; }
    main { display: flex; flex: 1; }
  </style>
</head>
<body>
  <header>
    <button id="login">GitHub ç™»å½•</button>
    <button id="newFile">æ–°å»ºæ–‡ä»¶</button>
    <button id="save">ä¿å­˜</button>
    <input id="filename" placeholder="æ–‡ä»¶åï¼Œä¾‹å¦‚ new-post.md" style="width:250px;">
  </header>

  <main>
    <textarea id="editor" placeholder="åœ¨è¿™é‡Œè¾“å…¥ Markdown å†…å®¹..."></textarea>
    <div id="preview"></div>
  </main>

  <script>
    const clientId = "ğŸ‘‰ å¡«å…¥ä½ çš„ GitHub OAuth Client ID ğŸ‘ˆ";
    const repo = "blog-source";
    const owner = "Sun1105";

    // ç™»å½•è·³è½¬
    document.getElementById('login').onclick = () => {
      const redirectUri = encodeURIComponent(window.location.href);
      const url = `https://github.com/login/oauth/authorize?client_id=${clientId}&scope=repo&redirect_uri=${redirectUri}`;
      window.location.href = url;
    };

    // å®æ—¶é¢„è§ˆ
    const editor = document.getElementById("editor");
    const preview = document.getElementById("preview");
    editor.addEventListener("input", () => {
      preview.innerHTML = marked.parse(editor.value);
    });

    // ä¿å­˜æ–‡ä»¶åˆ° GitHub
    document.getElementById('save').onclick = async () => {
      const token = localStorage.getItem("gh_token");
      if (!token) return alert("è¯·å…ˆç™»å½•");
      const filename = document.getElementById("filename").value;
      const content = btoa(unescape(encodeURIComponent(editor.value)));

      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/source/_posts/${filename}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          message: "update " + filename,
          content: content,
        }),
      });

      if (res.ok) alert("âœ… ä¿å­˜æˆåŠŸï¼");
      else alert("âŒ ä¿å­˜å¤±è´¥ï¼š" + res.statusText);
    };
  </script>
</body>
</html>
